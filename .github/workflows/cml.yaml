name: federated-learning-flower
on: [push]

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.8'
      
      - uses: iterative/setup-cml@v1
      
      - name: Set up Python environment
        run: |
          # Upgrade pip, create venv, install everything
          python -m pip install --upgrade pip
          pip debug --verbose
          pip install virtualenv
          virtualenv venv
          source venv/bin/activate

          # install mamba
          pip install mamba
          mamba init
          source ~/.bashrc
          mamba create  # (You may want to specify a name or environment file here)

          # Activate environment (again)
          mamba activate

          # Install your packages
          pip install xgboost
          pip install scikit-learn
          pip install -U flwr["simulation"]
          pip install -U "ray[all]"
          pip install torch
          pip install torchvision
          pip install torchaudio
          pip install hydra-core
          pip install -r requirements.txt
          
          # --------------------------------------------------------
          # "Export" the activate command so the next step sees it:
          # --------------------------------------------------------
          echo "source $GITHUB_WORKSPACE/venv/bin/activate" >> $GITHUB_ENV

      - name: Run your bagging script
        run: |
          # Use the environment file to activate the venv again
          source $GITHUB_ENV
          ./run_bagging.sh
